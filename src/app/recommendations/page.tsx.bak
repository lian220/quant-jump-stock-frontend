'use client';

import React, { useState, useEffect } from 'react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { PageSEO } from '@/components/seo';
import { getBuySignals, getConfidenceGrade, getScoreGrade } from '@/lib/api/predictions';
import { getStrategies } from '@/lib/api/strategies';
import { getCategoryLabel } from '@/lib/strategy-helpers';
import { Footer } from '@/components/layout/Footer';
import type { BuySignal } from '@/lib/api/predictions';
import type { Strategy } from '@/types/strategy';

export default function RecommendationsPage() {
  // ì¢…ëª© ì¶”ì²œ ìƒíƒœ
  const [recommendations, setRecommendations] = useState<BuySignal[]>([]);
  const [isLoadingRecommendations, setIsLoadingRecommendations] = useState(true);
  const [recommendationsError, setRecommendationsError] = useState<string | null>(null);

  // ì¸ê¸° ì „ëµ ìƒíƒœ
  const [popularStrategies, setPopularStrategies] = useState<Strategy[]>([]);
  const [isLoadingStrategies, setIsLoadingStrategies] = useState(true);
  const [strategiesError, setStrategiesError] = useState<string | null>(null);

  // ì¢…ëª© ë¶„ì„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì‹ ë¢°ë„ 0.7 ì´ìƒ)
  useEffect(() => {
    const fetchRecommendations = async () => {
      try {
        const response = await getBuySignals({ minConfidence: 0.7 });
        setRecommendations(response.data);
      } catch (error) {
        console.error('Failed to fetch recommendations:', error);
        setRecommendationsError('ì¢…ëª© ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        setIsLoadingRecommendations(false);
      }
    };

    fetchRecommendations();
  }, []);

  // ì¸ê¸° ì „ëµ ê°€ì ¸ì˜¤ê¸° (êµ¬ë…ììˆœ ìƒìœ„ 3ê°œ)
  useEffect(() => {
    const fetchPopularStrategies = async () => {
      try {
        const response = await getStrategies({
          sortBy: 'subscribers',
          page: 0,
          size: 3,
        });
        setPopularStrategies(response.strategies);
      } catch (error) {
        console.error('Failed to fetch strategies:', error);
        setStrategiesError('ì „ëµì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      } finally {
        setIsLoadingStrategies(false);
      }
    };

    fetchPopularStrategies();
  }, []);

  return (
    <>
      <PageSEO
        title="ì¢…ëª© ë¶„ì„ - Alpha Foundry"
        description="AI ê¸°ë°˜ ì˜¤ëŠ˜ì˜ ì£¼ëª© ì¢…ëª©ê³¼ ê²€ì¦ëœ í€€íŠ¸ íˆ¬ì ì „ëµì„ í™•ì¸í•˜ì„¸ìš”."
        keywords={['AI ì¢…ëª© ë¶„ì„', 'ë§¤ìˆ˜ ê´€ì‹¬', 'í€€íŠ¸ ì „ëµ', 'íˆ¬ì ì°¸ê³ ', 'Alpha Foundry']}
      />

      <div className="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900">
        {/* ë©”ì¸ ì»¨í…ì¸  */}
        <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
          {/* Hero ì„¹ì…˜: ì˜¤ëŠ˜ì˜ AI ì¶”ì²œ ì¢…ëª© */}
          <section className="mb-20">
            {/* í—¤ë” */}
            <div className="text-center mb-12">
              <Badge className="mb-4 bg-emerald-500/20 text-emerald-400 border-emerald-500/30 text-lg px-4 py-1">
                ğŸ¤– AI ë¶„ì„
              </Badge>
              <h1 className="text-5xl md:text-6xl font-bold text-white mb-6">
                ì˜¤ëŠ˜ì˜ ì£¼ëª© ì¢…ëª©
              </h1>
              <p className="text-xl text-slate-400 max-w-3xl mx-auto">
                ì‹¤ì‹œê°„ ë°ì´í„° ë¶„ì„ ê¸°ë°˜ ë§¤ìˆ˜ ê´€ì‹¬ ì¢…ëª©
                <br />
                <span className="text-emerald-400 font-semibold">ì‹ ë¢°ë„ 70% ì´ìƒ</span> ì¢…ëª©ë§Œ
                ì—„ì„ í–ˆìŠµë‹ˆë‹¤
              </p>

              {/* Beta ê²½ê³  ë°°ë„ˆ */}
              <div className="mt-8 max-w-4xl mx-auto">
                <Card className="bg-yellow-500/10 border-yellow-500/30">
                  <CardContent className="pt-6 pb-6">
                    <div className="flex items-start gap-3">
                      <span className="text-2xl">âš ï¸</span>
                      <div className="text-left">
                        <h3 className="text-yellow-400 font-semibold mb-2">
                          BETA - ì ìˆ˜ ì‹œìŠ¤í…œ ê°œì„  ì¤‘
                        </h3>
                        <p className="text-sm text-slate-300 leading-relaxed">
                          í˜„ì¬ ì¢…í•© ì ìˆ˜ëŠ” <strong className="text-yellow-400">ê¸°ìˆ ì  ì§€í‘œë§Œ</strong> ë°˜ì˜í•˜ì—¬
                          ë‚®ê²Œ í‘œì‹œë©ë‹ˆë‹¤ (ìµœëŒ€ 1.4ì ).
                          <br />
                          AI ì˜ˆì¸¡ ë° ê°ì • ë¶„ì„ í†µí•© í›„ ì ìˆ˜ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ìƒìŠ¹í•  ì˜ˆì •ì…ë‹ˆë‹¤ (ì˜ˆìƒ ìµœëŒ€ 7.5ì ).
                        </p>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </div>
            </div>

            {/* ë¡œë”© ìƒíƒœ */}
            {isLoadingRecommendations && (
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                {[1, 2, 3].map((i) => (
                  <Card key={i} className="bg-slate-800/50 border-slate-700">
                    <CardContent className="pt-6">
                      <div className="animate-pulse">
                        <div className="h-8 bg-slate-700 rounded mb-4"></div>
                        <div className="h-6 bg-slate-700 rounded mb-3 w-2/3"></div>
                        <div className="h-4 bg-slate-700 rounded mb-2"></div>
                        <div className="h-4 bg-slate-700 rounded w-3/4"></div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            )}

            {/* ì—ëŸ¬ ìƒíƒœ */}
            {recommendationsError && (
              <Card className="bg-slate-800/50 border-slate-700">
                <CardContent className="pt-6 text-center py-12">
                  <p className="text-xl text-red-400 mb-4">âš ï¸ {recommendationsError}</p>
                  <Button
                    onClick={() => window.location.reload()}
                    className="bg-emerald-600 hover:bg-emerald-700"
                  >
                    ë‹¤ì‹œ ì‹œë„
                  </Button>
                </CardContent>
              </Card>
            )}

            {/* ì¶”ì²œ ì¢…ëª© ì¹´ë“œ */}
            {!isLoadingRecommendations && !recommendationsError && recommendations.length > 0 && (
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                {recommendations.map((stock) => {
                  const confidenceGrade = getConfidenceGrade(stock.confidence);
                  const scoreGrade = getScoreGrade(stock.compositeScore);

                  return (
                    <Card
                      key={stock.symbol}
                      className="bg-gradient-to-br from-slate-800/80 to-slate-800/50 border-slate-700 hover:border-emerald-500/50 transition-all hover:shadow-lg hover:shadow-emerald-500/10"
                    >
                      <CardHeader>
                        <div className="flex items-start justify-between mb-3">
                          <div>
                            <CardTitle className="text-2xl text-white mb-1">
                              {stock.stockName}
                            </CardTitle>
                            <p className="text-sm text-slate-400 font-mono">{stock.symbol}</p>
                          </div>
                          <Badge className="bg-emerald-500/20 text-emerald-400 border-emerald-500/30 text-sm">
                            {stock.signal}
                          </Badge>
                        </div>

                        {/* ì‹ ë¢°ë„ & ì¢…í•© ì ìˆ˜ */}
                        <div className="grid grid-cols-2 gap-3 mb-4">
                          <div className="bg-slate-700/30 p-3 rounded-lg">
                            <p className="text-xs text-slate-400 mb-1">AI ì‹ ë¢°ë„</p>
                            <p className={`text-lg font-bold ${confidenceGrade.color}`}>
                              {(stock.confidence * 100).toFixed(0)}%
                            </p>
                            <p className="text-xs text-slate-500">{confidenceGrade.grade}</p>
                          </div>
                          <div className="bg-slate-700/30 p-3 rounded-lg">
                            <p className="text-xs text-slate-400 mb-1">ì¢…í•© ì ìˆ˜</p>
                            <p className={`text-lg font-bold ${scoreGrade.color}`}>
                              {stock.compositeScore.toFixed(1)}
                            </p>
                            <p className="text-xs text-slate-500">{scoreGrade.grade}</p>
                          </div>
                        </div>
                      </CardHeader>

                      <CardContent>
                        {/* ë¶„ì„ ê·¼ê±° */}
                        <div className="mb-4">
                          <p className="text-xs text-slate-400 mb-2">ğŸ” ë¶„ì„ ê·¼ê±°</p>
                          <p className="text-sm text-slate-300 leading-relaxed">
                            {stock.recommendationReason}
                          </p>
                        </div>

                        {/* CTA ë²„íŠ¼ */}
                        <Link href={`/stocks?query=${stock.symbol}`}>
                          <Button className="w-full bg-emerald-600 hover:bg-emerald-700">
                            ìƒì„¸ ë¶„ì„ ë³´ê¸° â†’
                          </Button>
                        </Link>
                      </CardContent>
                    </Card>
                  );
                })}
              </div>
            )}

            {/* ê²°ê³¼ ì—†ìŒ */}
            {!isLoadingRecommendations &&
              !recommendationsError &&
              recommendations.length === 0 && (
                <Card className="bg-slate-800/50 border-slate-700">
                  <CardContent className="pt-6 text-center py-16">
                    <p className="text-slate-400 text-lg mb-2">
                      ì˜¤ëŠ˜ì€ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤
                    </p>
                    <p className="text-slate-500 text-sm">
                      ì‹ ë¢°ë„ ê¸°ì¤€ì„ ì¶©ì¡±í•˜ëŠ” ë§¤ìˆ˜ ê´€ì‹¬ ì¢…ëª©ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                    </p>
                  </CardContent>
                </Card>
              )}
          </section>

          {/* êµ¬ë¶„ì„  */}
          <div className="relative mb-20">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-slate-700"></div>
            </div>
            <div className="relative flex justify-center">
              <span className="bg-slate-900 px-6 text-slate-500 text-sm">ì¥ê¸° íˆ¬ì ì „ëµ</span>
            </div>
          </div>

          {/* í•˜ë‹¨ ì„¹ì…˜: ì¸ê¸° íˆ¬ì ì „ëµ */}
          <section>
            <div className="text-center mb-12">
              <h2 className="text-4xl font-bold text-white mb-4">ê²€ì¦ëœ í€€íŠ¸ ì „ëµ</h2>
              <p className="text-lg text-slate-400 max-w-2xl mx-auto mb-6">
                ì¥ê¸° í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±ì„ ìœ„í•œ ì²´ê³„ì ì¸ íˆ¬ì ì „ëµì„ íƒìƒ‰í•˜ì„¸ìš”
              </p>
              <Link href="/strategies">
                <Button
                  variant="outline"
                  className="border-emerald-500/50 text-emerald-400 hover:bg-emerald-500/10"
                >
                  ëª¨ë“  ì „ëµ ë³´ê¸° â†’
                </Button>
              </Link>
            </div>

            {/* ë¡œë”© ìƒíƒœ */}
            {isLoadingStrategies && (
              <div className="grid md:grid-cols-3 gap-6">
                {[1, 2, 3].map((i) => (
                  <Card key={i} className="bg-slate-800/50 border-slate-700">
                    <CardContent className="pt-6">
                      <div className="animate-pulse">
                        <div className="h-6 bg-slate-700 rounded mb-4"></div>
                        <div className="h-4 bg-slate-700 rounded mb-2"></div>
                        <div className="h-4 bg-slate-700 rounded w-2/3"></div>
                      </div>
                    </CardContent>
                  </Card>
                ))}
              </div>
            )}

            {/* ì—ëŸ¬ ìƒíƒœ */}
            {strategiesError && (
              <Card className="bg-slate-800/50 border-slate-700">
                <CardContent className="pt-6 text-center">
                  <p className="text-red-400">{strategiesError}</p>
                </CardContent>
              </Card>
            )}

            {/* ì „ëµ ì¹´ë“œ */}
            {!isLoadingStrategies && !strategiesError && popularStrategies.length > 0 && (
              <div className="grid md:grid-cols-3 gap-6">
                {popularStrategies.map((strategy) => (
                  <Link key={strategy.id} href={`/strategies/${strategy.id}`}>
                    <Card className="bg-slate-800/50 border-slate-700 hover:border-cyan-500/50 transition-all h-full">
                      <CardHeader>
                        <div className="flex justify-between items-start mb-2">
                          <Badge
                            className={`
                              ${strategy.category === 'value' ? 'bg-purple-500/20 text-purple-400 border-purple-500/30' : ''}
                              ${strategy.category === 'momentum' ? 'bg-blue-500/20 text-blue-400 border-blue-500/30' : ''}
                              ${strategy.category === 'asset_allocation' ? 'bg-green-500/20 text-green-400 border-green-500/30' : ''}
                              ${strategy.category === 'quant_composite' ? 'bg-orange-500/20 text-orange-400 border-orange-500/30' : ''}
                              ${strategy.category === 'seasonal' ? 'bg-cyan-500/20 text-cyan-400 border-cyan-500/30' : ''}
                              ${strategy.category === 'ml_prediction' ? 'bg-pink-500/20 text-pink-400 border-pink-500/30' : ''}
                            `}
                          >
                            {getCategoryLabel(strategy.category)}
                          </Badge>
                          {strategy.isPremium && (
                            <Badge className="bg-yellow-500/20 text-yellow-400 border-yellow-500/30">
                              í”„ë¦¬ë¯¸ì—„
                            </Badge>
                          )}
                        </div>
                        <CardTitle className="text-xl text-white">{strategy.name}</CardTitle>
                        <CardDescription className="text-slate-400 line-clamp-2">
                          {strategy.description}
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="grid grid-cols-2 gap-4 text-sm">
                          <div>
                            <p className="text-slate-400">ì—°í‰ê·  ìˆ˜ìµë¥ </p>
                            <p className="text-emerald-400 font-semibold">
                              {strategy.annualReturn}
                            </p>
                          </div>
                          <div>
                            <p className="text-slate-400">ìƒ¤í”„ ë¹„ìœ¨</p>
                            <p className="text-cyan-400 font-semibold">{strategy.sharpeRatio}</p>
                          </div>
                          <div>
                            <p className="text-slate-400">êµ¬ë…ì</p>
                            <p className="text-slate-300 font-semibold">
                              {strategy.subscribers.toLocaleString()}ëª…
                            </p>
                          </div>
                          <div>
                            <p className="text-slate-400">í‰ì </p>
                            <p className="text-yellow-400 font-semibold">â­ {strategy.rating}</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  </Link>
                ))}
              </div>
            )}
          </section>

          {/* CTA ì„¹ì…˜ */}
          <section className="mt-20">
            <Card className="bg-gradient-to-r from-emerald-600 to-cyan-600 border-0">
              <CardContent className="text-center py-12">
                <h2 className="text-3xl font-bold mb-4 text-white">
                  ì§€ê¸ˆ ë°”ë¡œ ë°ì´í„° ê¸°ë°˜ íˆ¬ìë¥¼ ì‹œì‘í•˜ì„¸ìš”
                </h2>
                <p className="text-xl mb-8 text-emerald-100">
                  AI ì¶”ì²œ ì¢…ëª©ê³¼ ê²€ì¦ëœ í€€íŠ¸ ì „ëµìœ¼ë¡œ ìŠ¤ë§ˆíŠ¸í•œ íˆ¬ìë¥¼ ê²½í—˜í•˜ì„¸ìš”.
                </p>
                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                  <Link href="/strategies">
                    <Button size="lg" className="bg-white text-emerald-700 hover:bg-slate-100">
                      ì „ëµ ë‘˜ëŸ¬ë³´ê¸°
                    </Button>
                  </Link>
                  <Link href="/auth">
                    <Button
                      size="lg"
                      variant="outline"
                      className="border-white text-white hover:bg-white/10"
                    >
                      ë¬´ë£Œ íšŒì›ê°€ì…
                    </Button>
                  </Link>
                </div>
              </CardContent>
            </Card>
          </section>
        </main>

        {/* í‘¸í„° */}
        <Footer />
      </div>
    </>
  );
}
